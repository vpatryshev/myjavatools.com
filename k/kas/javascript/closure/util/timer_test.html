<!DOCTYPE html>

<!--
Copyright 2006 Google Inc.
 All Rights Reserved.
-->

<html>
<head>
<title>goog.Timer Tests</title>
<script type="text/javascript" src="../../../third_party/java/jsunit/jsunit2.2/app/jsUnitCore.js"></script>
<script type="text/javascript" src="../base.js"></script>
<script type="text/javascript">
  goog.require('goog.events');
  goog.require('goog.events.EventTarget');
  goog.require('goog.Timer');
</script>

</head>
<body>
<script type="text/javascript">

  // Override setInterval
  var maxDuration = 60 * 1000; // 60s
  var totalDuration = 0;
  var intervalIds = {};
  var intervalIdCounter = 0;
  goog.global.setInterval = function(fn, time) {
    var id = intervalIdCounter++;
    intervalIds[id] = true;
    for (var total = 0;
         total < maxDuration && id in intervalIds;
         total += time) {

      fn();
    }
    return id;
  };

  goog.global.clearInterval = function(id) {
    delete intervalIds[id];
  };

  // Run a test for 60s and see how many counts we get
  function runTest(string, ticks, number) {
    var t = new goog.Timer(ticks);
    var count = 0;
    goog.events.listen(t, 'tick', function(evt) {
      count++;
    });
    t.start();
    assertEquals(string, number, count);
    t.stop();
    goog.events.removeAll(t);
  }


  function test100msTicks() {
    // Desc, interval in ms, expected ticks in 60s
    runTest('10 ticks per second for 60 seconds', 100, 600);
  }

  function test500msTicks() {
    runTest('2 ticks per second for 60 seconds', 500, 120);
  }

  function test1sTicks() {
    runTest('1 tick per second for 60 seconds', 1000, 60);
  }

  function test2sTicks() {
    runTest('1 tick every 2 seconds for 60 seconds', 2000, 30);
  }

  function test5sTicks() {
    runTest('1 tick every 5 seconds for 60 seconds', 5000, 12);
  }

  function test10sTicks() {
    runTest('1 tick every 10 seconds for 60 seconds', 10000, 6);
  }

  function test30sTicks() {
    runTest('1 tick every 30 seconds for 60 seconds', 30000, 2);
  }

  function test60sTicks() {
    runTest('1 tick every 60 seconds', 60000, 1);
  }

  function testCallOnce() {
    var c = 0;
    goog.Timer.callOnce(function() {
      if (c > 0) {
        assertTrue('callOnce should only be called once', false);
      }
      c++;
    });

    c = 0;
    var obj = {};
    goog.Timer.callOnce(function() {
      if (c > 0) {
        assertTrue('callOnce should only be called once', false);
      }
      assertEquals(obj, this);
      c++;
    }, 1, obj);
  }

</script>
</body>
</html>
