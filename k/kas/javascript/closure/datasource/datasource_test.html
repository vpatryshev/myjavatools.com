<!--
Copyright 2006 Google Inc.
 All Rights Reserved.
-->

<html>
<head>
<title>Closure Unit Tests - goog.ds</title>
<script type="text/javascript" src="../../../third_party/java/jsunit/jsunit2.2/app/jsUnitCore.js"></script>
<script type="text/javascript" src="../base.js"></script>
<script type="text/javascript">
  goog.require('goog.ds.DataSource');
  goog.require('goog.ds.JsDataSource');
  goog.require('goog.ds.XmlDataSource');
  goog.require('goog.array');
  goog.require('goog.dom.xml');
</script>
</head>

<script type="text/javascript">
  var xmlDs;
  var jsDs;

  function setUp() {
    var xmltext ='<test><node value="5">some data</node></test>';
    var doc = goog.dom.xml.loadXml(xmltext);
    xmlDs = new goog.ds.XmlDataSource(doc.documentElement, null, null);
        
    var jsObj = { node: { '@value': 5, '#text': 'some data', name: 'bob',
        age: 35, alive: true, aliases: ['bobbo', 'robbo']} };
    jsDs = new goog.ds.JsDataSource(jsObj, 'JSDS', null);
  }

  function testJsDataSource() {
    var child = jsDs.getChildNode('node');
    var attr = child.getChildNode('@value');
    var text = child.getChildNode('#text');
    var name = child.getChildNode('name');
    var age = child.getChildNode('age');
    var alive = child.getChildNode('alive');
    var aliases = child.getChildNode('aliases');
    
    assertEquals('Attribute get', attr.get(), 5);
    assertEquals('Text get', text.get(), 'some data');
    assertEquals('string node get', name.get(), 'bob');
    assertEquals('Number get', age.get(), 35);
    assertEquals('Boolean get', alive.get(), true);
    assertEquals('Array value', aliases.get().getByIndex(1).get(), 'robbo');
    assertEquals('Array length', aliases.get().getCount(), 2);
    
    assertEquals('Datasource name', jsDs.getDataName(), 'JSDS');
  }
  
  function testXmlDataSource(){
    var child = xmlDs.getChildNode('node');
    var attr = child.getChildNode('@value');
    var text = child.getChildNode('#text');
        
    assertEquals('Attribute get', attr.get(), '5');
    assertEquals('Text get', text.get(), 'some data');
    assertEquals('Attr child node value', child.getChildNodeValue('@value'), '5');
  }
  
  function testChildNodeValue() {
    var child = jsDs.getChildNode('node');
    assertEquals('Child node value', child.getChildNodeValue('age'), 35);
  }
  
  function testJsSet() {
    assertNull('Get new child node is null', jsDs.getChildNode('Newt').get());
    
    jsDs.getChildNode('Newt').set('A newt');
    assertEquals('New string child node',
        jsDs.getChildNode('Newt').get(), 'A newt');
        
    jsDs.getChildNode('Number').set(35);
    assertEquals('New number child node', jsDs.getChildNodeValue('Number'), 35);
    
    var numNode = jsDs.getChildNode('Number');
    jsDs.getChildNode('Number').set(38);
    assertEquals('Changed number child node', numNode.get(), 38);
    
    try {
      jsDs.set(5);
      fail('Shouldn\'t be able to set a group node yet');
    } catch (e) {
    }
  }
  
  function testDataManager() {
    var dm = goog.ds.DataManager.getInstance();
    assertNotNull('DataManager exists', dm);
    assertTrue('No datasources yet', dm.getChildNodes().getCount() == 0);
    dm.addDataSource(jsDs, true);
    assertTrue('One data source', dm.getChildNodes().getCount() == 1);
    assertEquals('Renamed to global prefix',
                 '$JSDS',
                 dm.getChildNodes().getByIndex(0).getDataName());
  }


// For using the debugger
function runTests() {
  setUp();
  var fns = [ testJsDataSource, testXmlDataSource, testChildNodeValue,
      testJsSet, testDataManager];
  for (var i = 0; i < fns.length; i++) {
    fns[i]();
  }
}

</script>

</head>
<body>
<h1>goog.ds</h1>
<form>
<button onclick='runTests()'>Run tests</button>
</form>
</body>
</html>
